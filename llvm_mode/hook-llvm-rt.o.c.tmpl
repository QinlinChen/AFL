/* Generated by genhook.py */
#define _GNU_SOURCE

#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdarg.h>

#include "../config.h"
#include "snap2exe/checkpoint.h"


extern void __afl_manual_init(void);

#define AFL_INIT() do { \
    static volatile char *_A __attribute__((used)); \
    _A = (char*) DEFER_SIG; \
    __afl_manual_init(); \
  } while (0)


int __hook_scanf(const char *format, ...)
{
  if (s2e_checkpoint(S2E_DEFAULT_SAVE_DIR, S2E_SCHED_PROB) == 1)
    AFL_INIT();

  va_list ap;
  va_start(ap, format);
  int ret = vscanf(format, ap);
  va_end(ap);

  return ret;
}

int __hook_fscanf(FILE *stream, const char *format, ...)
{
  if (s2e_checkpoint(S2E_DEFAULT_SAVE_DIR, S2E_SCHED_PROB) == 1)
    AFL_INIT();

  va_list ap;
  va_start(ap, format);
  int ret = vfscanf(stream, format, ap);
  va_end(ap);

  return ret;
}

{% for func_info in func_infos %}
{{ func_info.ret_type }} __hook_{{ func_info.name }}({{ func_info.params_str() }})
{
  if (s2e_checkpoint(S2E_DEFAULT_SAVE_DIR, S2E_SCHED_PROB) == 1)
    AFL_INIT();

  return {{ func_info.name }}({{ func_info.args_str() }});
}
{% endfor %}